---
title: "alembicã®ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãæ–¹"
emoji: "ðŸ"
type: "tech"
topics:
  - "python"
  - "migration"
  - "python3"
  - "alembic"
published: true
published_at: "2024-04-24 09:58"
---

Pythonã®ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«alembicã§ã€ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆã‚„åˆ—è¿½åŠ ç­‰ã‚’ã©ã†è¨˜è¼‰ã™ã‚Œã°ã‚ˆã„ã‹ã¾ã¨ã‚ã¾ã™ã€‚
alembicã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚„è¨­å®šæ–¹æ³•ã«ã¤ã„ã¦ã¯è§¦ã‚Œã¾ã›ã‚“ã€‚

# ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
```python:
from datetime import datetime

from alembic import op
from sqlalchemy import DATETIME, VARCHAR, Column, Integer


def upgrade() -> None:
    op.create_table(
        "users",
        Column("id", Integer, primary_key=True),
        Column("name", VARCHAR(255), nullable=False),
        Column("email", VARCHAR(255), nullable=False),
        Column("deleted_at", DATETIME, default=None),
        Column("created_at", DATETIME, default=datetime.now, nullable=False),
        Column(
            "updated_at",
            DATETIME,
            default=datetime.now,
            nullable=False,
            onupdate=datetime.now,
        ),
    )
```

# ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤
```python:
from alembic import op


def upgrade() -> None:
    op.drop_table("users")
```

# åˆ—è¿½åŠ 
:::message
`add_column()`ã§ã¯ã‚«ãƒ©ãƒ ã‚’è¿½åŠ ã™ã‚‹ä½ç½®ã®æŒ‡å®šãŒã§ããªã„(æœ€å¾Œå°¾ã«è¿½åŠ ã•ã‚Œã‚‹)ã®ã§ã€ä½ç½®ã‚’æŒ‡å®šã—ãŸã„å ´åˆã¯å¾Œè¿°ã®ä»»æ„ã®SQLã‚’å®Ÿè¡Œã™ã‚‹æ–¹æ³•ã‚’ä½¿ç”¨ã™ã‚‹
:::
```python:
from alembic import op
from sqlalchemy import VARCHAR, Column
from sqlalchemy.dialects.mysql import TINYINT


def upgrade() -> None:
    op.add_column("users", Column("deleted", TINYINT))
```

# åˆ—å‰Šé™¤
```python:
from alembic import op


def upgrade() -> None:
    op.drop_column("users", "email")
```

# åˆ—å®šç¾©å¤‰æ›´
```python:
import sqlalchemy as sa
from alembic import op


def upgrade() -> None:
    op.alter_column(
        "users",
        "name",
        existing_type=sa.VARCHAR(255),
        type_=sa.VARCHAR(20),
        nullable=False,
    )
```

# ä»»æ„ã®SQLå®Ÿè¡Œ
`sa.text()`ã‚’ä½¿ã†ã“ã¨ã§ã€æ–‡å­—åˆ—ã¨ã—ã¦è¨˜è¼‰ã—ãŸSQLã®å®Ÿè¡Œã‚‚å¯èƒ½ã§ã™ã€‚å¤‰æ•°ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯`:å¤‰æ•°å`ã¨ã—ã¦ã€`.bindparams()`ã§å€¤ã‚’è¨­å®šã™ã‚‹ã€‚
ã„ãã¤ã‹ä¾‹ã‚’è¨˜è¼‰ã—ã¾ã™ã€‚

## insert
```python:
import sqlalchemy as sa
from alembic import op


def upgrade() -> None:
    op.execute(
        sa.text(
            """
            INSERT INTO users (id, name, email, created_at, updated_at)
            VALUES (:id, :name, :email, :created_at, :updated_at)
        """
        ).bindparams(
            sa.bindparam("id", 1),
            sa.bindparam("name", "John Smith"),
            sa.bindparam("email", "john@example.com"),
            sa.bindparam("created_at", "2000-01-01"),
            sa.bindparam("updated_at", "2000-01-01"),
        )
    )
```

## ã‚«ãƒ©ãƒ è¿½åŠ (ä½ç½®æŒ‡å®š)
```python:
def upgrade() -> None:
    op.execute(
        sa.text(
            """
            ALTER TABLE users ADD deleted TINYINT(1) NOT NULL DEFAULT 0
	    AFTER email
        """
        )
```
