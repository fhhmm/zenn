---
title: "Step Functionsã®Parameterã‚’ä½¿ã£ã¦ä¸Šé™ã‚ã‚Šã®ãƒ«ãƒ¼ãƒ—ã‚’ä½œã‚‹"
emoji: "ğŸ«§"
type: "tech"
topics:
  - "aws"
  - "lambda"
  - "stepfunctions"
published: true
published_at: "2024-04-24 10:03"
---

# æ¦‚è¦
`Result Path`ã¨`Parameter`ã‚’åˆ©ç”¨ã—ã¦ãƒ«ãƒ¼ãƒ—ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½œæˆã—ã¾ã—ãŸã€‚Lambdaã§å›æ•°ã‚’åˆ¶å¾¡ã™ã‚‹ã‚ˆã‚Šã‚‚ç°¡æ˜“ãªæ–¹æ³•ã§ã™ã€‚


# ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³

## ã‚°ãƒ©ãƒ•
![](https://storage.googleapis.com/zenn-user-upload/2327d9dfcace-20240201.png)

## JSON
```json:
{
  "Comment": "",
  "StartAt": "Init",
  "States": {
    "Init": {
      "Type": "Pass",
      "Result": [
        true,
        true,
        true,
        false
      ],
      "Next": "Can Execute",
      "ResultPath": "$.canExecute"
    },
    "Can Execute": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.canExecute[0]",
          "BooleanEquals": true,
          "Comment": "true",
          "Next": "Lambda Invoke"
        }
      ],
      "Default": "Fail"
    },
    "Lambda Invoke": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "Payload.$": "$",
        "FunctionName": "arn:aws:lambda:ap-northeast-1:876462513854:function:sampleFunc:$LATEST"
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException",
            "Lambda.TooManyRequestsException"
          ],
          "IntervalSeconds": 1,
          "MaxAttempts": 3,
          "BackoffRate": 2
        }
      ],
      "Next": "Is Success",
      "ResultPath": "$.output"
    },
    "Is Success": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.output.Payload.result",
          "BooleanEquals": true,
          "Comment": "true",
          "Next": "Success"
        }
      ],
      "Default": "Pop Element from List"
    },
    "Success": {
      "Type": "Succeed"
    },
    "Pop Element from List": {
      "Type": "Pass",
      "Next": "Wait",
      "Parameters": {
        "canExecute.$": "$.canExecute[1:]"
      }
    },
    "Fail": {
      "Type": "Fail"
    },
    "Wait": {
      "Type": "Wait",
      "Seconds": 5,
      "Next": "Can Execute"
    }
  }
}
```

# ã‚„ã£ã¦ã„ã‚‹ã“ã¨
## Init
ãƒ«ãƒ¼ãƒ—ã®ä¸Šé™å›æ•°ã‚’åˆ¶å¾¡ã™ã‚‹ãŸã‚ã®å¤‰æ•°ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚å…ˆé ­ã‹ã‚‰ä¸Šé™å›æ•°åˆ†ã ã‘`true`ã‚’ä¸¦ã¹ãŸé…åˆ—ã‚’å®šç¾©ã—ã¾ã™ã€‚
å¾Œç¶šã®å‡¦ç†ã§ã‚‚ã“ã®å¤‰æ•°ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ã€ResultPathã‚’è¨­å®šã—ã¾ã™ã€‚
```json:ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©(Initéƒ¨åˆ†)
    "Init": {
      "Type": "Pass",
      "Result": [
        true,
        true,
        true,
        false
      ],
      "Next": "Can Execute",
      "ResultPath": "$.canExecute"
    },
```

## Can Execute
`canExecute`ã®å…ˆé ­ã®è¦ç´ ãŒ`true`ã®å ´åˆã«å¾Œç¶šã®Lambdaã‚’å®Ÿè¡Œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚
```json:ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©(Can Executeéƒ¨åˆ†)
    "Can Execute": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.canExecute[0]",
          "BooleanEquals": true,
          "Comment": "true",
          "Next": "Lambda Invoke"
        }
      ],
      "Default": "Fail"
    },
```

## Invoke Lambda
ãƒ¡ã‚¤ãƒ³å‡¦ç†ã¨ãªã‚‹Lambdaã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
ã“ã®ä¾‹ã§ã¯ã‚µãƒ³ãƒ—ãƒ«ã¨ã—ã¦`true`ã‹`false`ã‚’è¿”ã™ã ã‘ã®é–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
```python:Lambdaé–¢æ•°
import random

def lambda_handler(event, context):
    return {'result': bool(random.randint(0,1))}
```


```json:ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©(Lambda Invokeéƒ¨åˆ†)
    "Lambda Invoke": {
      "Type": "Task",
      "Resource": "arn:aws:states:::lambda:invoke",
      "Parameters": {
        "Payload.$": "$",
        "FunctionName": "arn:aws:lambda:ap-northeast-1:876462513854:function:sampleFunc:$LATEST"
      },
      "Retry": [
        {
          "ErrorEquals": [
            "Lambda.ServiceException",
            "Lambda.AWSLambdaException",
            "Lambda.SdkClientException",
            "Lambda.TooManyRequestsException"
          ],
          "IntervalSeconds": 1,
          "MaxAttempts": 3,
          "BackoffRate": 2
        }
      ],
      "Next": "Is Success",
      "ResultPath": "$.output"
    },
```

## Is Success
Lambdaå®Ÿè¡Œçµæœã‚’åˆ¤å®šã—ã¦ã„ã¾ã™ã€‚`true`ã®å ´åˆã¯å‡¦ç†çµ‚äº†ã€ãã‚Œä»¥å¤–ã®å ´åˆã¯ãƒ«ãƒ¼ãƒ—(ãƒªãƒˆãƒ©ã‚¤)å‡¦ç†ã¸æµã—ã¾ã™ã€‚
```json:ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³å®šç¾©(is Successéƒ¨åˆ†)
    "Is Success": {
      "Type": "Choice",
      "Choices": [
        {
          "Variable": "$.output.Payload.result",
          "BooleanEquals": true,
          "Comment": "true",
          "Next": "Success"
        }
      ],
      "Default": "Pop Element from List"
    },
```

## Pop Element from List
inputã¨ãªã‚‹`canExecute`ã®å…ˆé ­ã®è¦ç´ ã‚’popã—ã¦ã€æ–°ã—ãoutputã¨ã™ã‚‹ã“ã¨ã§ãƒ«ãƒ¼ãƒ—ã®å›æ•°ã‚’åˆ¶å¾¡ã—ã¦ã„ã¾ã™ã€‚
ä¸‹è¨˜ã®ã‚ˆã†ã«ãƒ«ãƒ¼ãƒ—ãŒå›ã‚‹ã”ã¨ã«å…ˆé ­ã‹ã‚‰è¦ç´ ãŒpopã•ã‚Œã¦ã„ãã€ä¸Šé™å›æ•°ã¾ã§é”ã™ã‚‹ã¨Can Executeã‚¹ãƒ†ãƒ¼ãƒˆã§å®Ÿè¡Œä¸å¯ã¨åˆ¤å®šã•ã‚Œã‚‹ä»•çµ„ã¿ã§ã™ã€‚
- 1å›ç›®: `[true, true, true, false]`â†’`[true, true, false]`
- 2å›ç›®: `[true, true, false]`â†’`[true, false]`
- 3å›ç›®: `[true, false]`â†’`[false]`

ã“ã‚Œã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã«Parametersã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã®ã§ã™ãŒã€Parametersã«ã¤ã„ã¦ã¯ä¸‹è¨˜ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚
https://dev.classmethod.jp/articles/stepfunctions-parameters-inter-states/

ã¾ãŸã€é…åˆ—ã®è¦ç´ ã‚’popã™ã‚‹å‡¦ç†ã¯ä¸‹è¨˜ã‚’å‚è€ƒã«ã•ã›ã¦ã„ãŸã ãã¾ã—ãŸã€‚
https://docs.aws.amazon.com/ja_jp/step-functions/latest/dg/sample-project-transfer-data-sqs.html#sample-sqs-code-examples
