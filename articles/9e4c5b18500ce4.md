---
title: "pytestã§éžåŒæœŸé–¢æ•°ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹"
emoji: "ðŸ"
type: "tech"
topics:
  - "python"
  - "python3"
  - "fastapi"
  - "pytest"
  - "async"
published: true
published_at: "2024-04-24 09:57"
---

FastAPIã‚’ä½¿ã£ã¦ã„ã‚‹ã¨éžåŒæœŸé–¢æ•°ã‚’æ‰±ã†ã“ã¨ãŒå¢—ãˆã¾ã™ã€‚
éžåŒæœŸé–¢æ•°ã®ãƒ†ã‚¹ãƒˆã®æ›¸ãæ–¹ã‚’ãƒ¡ãƒ¢ã¨ã—ã¦è¨˜è¼‰ã—ã¾ã™ã€‚
:::message
è¨˜è¼‰ã®ã‚³ãƒ¼ãƒ‰ä¾‹ã§ã¯å˜ç´”åŒ–ã®ãŸã‚ä¸€éƒ¨ã‚³ãƒ¼ãƒ‰ã‚’çœç•¥ã—ã¦ã„ã¾ã™ã€‚
:::

# ã‚³ãƒ¼ãƒ‰
ä¸‹è¨˜ã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã‚±ãƒ¼ã‚¹ã‚’è€ƒãˆã‚‹ã€‚
```python:repo.py
from sqlalchemy import select
from sqlalchemy.orm import Session


class UsersRepository:
    async def find_by_id(session: Session, id: int) -> User:
        result = await session.execute(select(User).where(User.id == id)
        return result.scalars().one_or_none()
```

ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã€‚
```python:test.py
import pytest
from .repo import UsersRepository


@pytest.mark.asyncio
async def test_find_by_id():
    result = await UsersRepository.find_by_id(session=session, id=1)
    assert isinstance(result, User)
```

# è§£èª¬
`@pytest.mark.asyncio`ã‚’ã¤ã‘ãšã«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä¸‹è¨˜ã®WarningãŒå‡ºã‚‹ã€‚

```:Waring
PytestUnhandledCoroutineWarning: async def functions are not natively supported and have been skipped.
  You need to install a suitable plugin for your async framework, for example:
    - anyio
    - pytest-asyncio
    - pytest-tornasync
    - pytest-trio
    - pytest-twisted
    warnings.warn(PytestUnhandledCoroutineWarning(msg.format(nodeid)))
```
pytestå˜ä½“ã§ã¯éžåŒæœŸé–¢æ•°ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ãªã„ã®ã§ãƒ†ã‚¹ãƒˆãŒã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã„ã‚‹ã€‚
éžåŒæœŸé–¢æ•°ãƒ†ã‚¹ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ã¤ã‘ã‚‹ã¨ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
```bash:zsh
poetry add -D pytest-asyncio
```

# mock
ã¡ãªã¿ã«éžåŒæœŸé–¢æ•°ã®mockã¯åŒæœŸé–¢æ•°ã¨åŒæ§˜ã«ã§ãã¾ã—ãŸã€‚
```python:service.py
from sqlalchemy.orm import Session


class UsersService:
    @staticmethod
    async def find_by_id(session: Session, id: int) -> User:
        return await UsersRepository.find_by_id(session=session, id=id)
```
```python:test.py
from unittest.mock import patch

import pytest


@pytest.mark.asyncio
@patch("repo.UsersRepository.find_by_id")
async def test_find_by_id(self, find_by_id):
    find_by_id.return_value = User(id=1)
    result = await UsersService.find_by_id(session="dummy", id=1)

    find_by_id.assert_called_once_with(session="dummy", id=1)
    assert isinstance(result, User)
```
